<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CardScan - Download Data</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #6262a6;
        --primary-dark: #4e4e85;
        --primary-light: #eef0f7;
        --text-dark: #1e293b;
        --text-gray: #64748b;
        --bg-body: #f1f5f9;
        --white: #ffffff;
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --sidebar-width: 260px;
        --border-color: #e2e8f0;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        background-color: var(--bg-body);
        display: flex;
        min-height: 100vh;
      }

      /* ... [KEEP ALL YOUR EXISTING SIDEBAR/HEADER CSS HERE] ... */
      /* Copied purely for context, assumes you keep your existing CSS above */
      .sidebar { width: var(--sidebar-width); background-color: var(--primary); color: var(--white); display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; padding: 24px; z-index: 50; }
      .main-wrapper { margin-left: var(--sidebar-width); flex: 1; display: flex; flex-direction: column; }
      header { background-color: var(--white); height: 70px; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 40; }
      .search-bar { display: flex; align-items: center; background-color: var(--bg-body); padding: 10px 16px; border-radius: 8px; width: 350px; border: 1px solid transparent; transition: 0.2s; }
      .search-bar input { border: none; background: none; outline: none; width: 100%; font-size: 14px; color: var(--text-dark); }
      .content { padding: 32px; }
      .page-title { font-size: 24px; font-weight: 700; color: var(--text-dark); margin-bottom: 24px; }
      .panel { background: var(--white); border-radius: 12px; box-shadow: var(--shadow); padding: 24px; display: flex; flex-direction: column; position: relative; } /* Added position relative */
      .download-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 24px; }
      .picker-panel { margin-bottom: 24px; }
      .picker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
      .table-container { width: 100%; overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 14px; }
      thead th { text-align: left; padding: 12px 16px; background-color: #f8fafc; color: var(--text-gray); font-weight: 600; border-bottom: 1px solid var(--border-color); text-transform: uppercase; font-size: 12px; }
      tbody td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); color: var(--text-dark); }
      .code-pill { font-family: "Courier New", monospace; background: var(--bg-body); padding: 4px 8px; border-radius: 4px; color: var(--primary-dark); font-weight: 600; font-size: 13px; }
      .pagination { display: flex; justify-content: flex-end; align-items: center; margin-top: 20px; gap: 12px; }
      .page-btn { background: var(--white); border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; color: var(--text-gray); font-size: 13px; }
      .export-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
      .form-group { margin-bottom: 16px; }
      .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; }
      .form-input { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--white); font-size: 14px; color: var(--text-dark); height: 42px; }
      .checkbox-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
      .custom-checkbox { display: flex; align-items: center; cursor: pointer; font-size: 14px; color: var(--text-dark); }
      .custom-checkbox input { width: 18px; height: 18px; margin-right: 10px; accent-color: var(--primary); }
      .download-btn { width: 100%; background-color: var(--primary); color: var(--white); border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
      .run-btn { background-color: #10b981; }
      
      /* --- NEW STYLES FOR BLUR & MODAL --- */
      
      /* Overlay to blur the panel */
      .panel-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(4px);
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        text-align: center;
        padding: 20px;
      }

      .overlay-message {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 12px;
      }

      .stats-btn {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
      }
      .stats-btn:hover { background-color: var(--primary-dark); }

      /* Modal Background */
      .modal-backdrop {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
      }

      /* Modal Content */
      .modal-content {
        background-color: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title { font-weight: 700; font-size: 18px; color: var(--text-dark); }
      .close-modal { cursor: pointer; color: var(--text-gray); font-size: 20px; }
      .close-modal:hover { color: var(--text-dark); }

      .modal-body {
        padding: 24px;
        overflow-y: auto;
      }

      .stat-card {
        background: #f8fafc;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 24px;
      }
      .stat-number { font-size: 32px; font-weight: 700; color: var(--primary); }
      .stat-label { font-size: 13px; color: var(--text-gray); text-transform: uppercase; font-weight: 600; }

      .error-list {
        list-style: none;
        margin-top: 10px;
      }
      .error-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
      }
      .error-item:last-child { border-bottom: none; }
      .err-code { font-family: monospace; font-weight: 600; color: var(--text-dark); }
      .err-reason { color: #ef4444; }

    </style>
  </head>
  <body>
    <%- include("partials/sidebar", { activePage: "download" }) %>

    <div class="main-wrapper">
      <header>
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search..." />
        </div>
        <div class="header-actions">
           <div style="width: 35px; height: 35px; background: #6262a6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">AD</div>
        </div>
      </header>

      <div class="content">
        <h1 class="page-title">Data Management</h1>

        <% var hasPicker = (typeof users !== "undefined" && users && users.length); %>
        <% if (hasPicker) { %>
          <div class="panel picker-panel">
            <div class="picker-grid">
              <div>
                <label class="form-label" for="userSelect"><i class="fas fa-user-circle"></i> Select User</label>
                <select id="userSelect" class="form-input">
                  <option value="" <%= !selectedUserId ? "selected" : "" %> disabled>Choose user...</option>
                  <% for (var i=0; i<users.length; i++) { %>
                    <option value="<%= users[i].id %>" <%= (selectedUserId === users[i].id) ? "selected" : "" %>><%= users[i].name %></option>
                  <% } %>
                </select>
              </div>
              <div>
                <label class="form-label" for="tagSelect"><i class="fas fa-tag"></i> Select Tag</label>
                <select id="tagSelect" class="form-input" <%= (tagsForUser && tagsForUser.length) ? "" : "disabled" %>>
                  <option value="" disabled selected>Choose tag...</option>
                  <% if (tagsForUser && tagsForUser.length) { %>
                    <% for (var j=0; j<tagsForUser.length; j++) { %>
                      <option value="<%= tagsForUser[j].id %>" <%= (selectedTagId === tagsForUser[j].id) ? "selected" : "" %>><%= tagsForUser[j].name %></option>
                    <% } %>
                  <% } %>
                </select>
              </div>
            </div>
          </div>
        <% } %>

        <div class="download-grid">
          <div class="panel">
            <h3 style="margin-bottom: 20px; font-size: 18px; color: var(--text-dark);" id="tableTitle">Available Codes</h3>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th><i class="fas fa-barcode"></i> Barcode</th>
                    <th><i class="fas fa-key"></i> Activation Code</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
            </div>
            <div class="pagination">
              <button class="page-btn" id="prevBtn" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
              <span class="page-info" id="pageInfo">Page 1 of 1</span>
              <button class="page-btn" id="nextBtn" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
          </div>

          <div style="display: flex; flex-direction: column; gap: 24px;">
            
            <div class="panel" style="height: fit-content">
                <div class="export-title">Export Options</div>
                <p style="font-size: 13px; color: var(--text-gray); margin-bottom: 16px;">Select columns to download.</p>
                <div class="checkbox-group">
                <label class="custom-checkbox"><input type="checkbox" id="chkBarcode" checked /> Barcode ID</label>
                <label class="custom-checkbox"><input type="checkbox" id="chkActivation" checked /> Activation Code</label>
                </div>
                <button class="download-btn" id="downloadBtn" onclick="downloadFile()"><i class="fas fa-file-download"></i> Download .txt</button>
            </div>

            <div class="panel" style="height: fit-content; min-height: 250px;">
                <div class="export-title">Activate</div>
                
                <p style="font-size: 13px; color: var(--text-gray); margin-bottom: 16px;">
                    Schedule EAN activation.
                </p>

                <div class="form-group">
                    <label class="form-label" for="eanSelect"><i class="fas fa-qrcode"></i> Select EAN</label>
                    <select id="eanSelect" class="form-input">
                        <option value="" disabled selected>Choose EAN...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="activateTime"><i class="far fa-calendar-alt"></i> Finish Date & Time</label>
                    <input type="datetime-local" id="activateTime" class="form-input" />
                </div>

                <button class="download-btn run-btn" onclick="runActivation()">
                    <i class="fas fa-play"></i> Run
                </button>
                <div id="activateStatus" style="margin-top:10px;font-size:13px;color:#64748b;"></div>


                <% if (typeof selectedTagId === 'undefined' || !selectedTagId) { %>
                  <div class="panel-overlay">
                    <i class="fas fa-arrow-up" style="font-size: 24px; color: var(--text-gray); margin-bottom: 10px;"></i>
                    <div class="overlay-message">Please choose a tag first</div>
                  </div>
                <% } %>

                <% if (typeof selectedTagId !== 'undefined' && selectedTagId && typeof activeCampaign !== 'undefined' && activeCampaign) { %>
                   <div class="panel-overlay">
                    <i class="fas fa-cog fa-spin" style="font-size: 24px; color: var(--primary); margin-bottom: 10px;"></i>
                    <div class="overlay-message">Activation Running / Finished</div>
                    <button class="stats-btn" onclick="openStatsModal()">
                      <i class="fas fa-chart-pie"></i> Show Statistics
                    </button>
                  </div>
                <% } %>

            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="statsModal" class="modal-backdrop">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Activation Statistics</h3>
          <i class="fas fa-times close-modal" onclick="closeStatsModal()"></i>
        </div>
        <div class="modal-body">
          
          <div class="stat-card">
            <div class="stat-number" id="modalPercent">0%</div>
            <div class="stat-label">Successfully Activated</div>
          </div>

          <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">Failed Activations</h4>
          <div style="background: #fff; border: 1px solid var(--border-color); border-radius: 8px;">
            <ul class="error-list" id="modalErrorList">
              <li class="error-item" style="justify-content: center; color: var(--text-gray);">No errors found.</li>
            </ul>
          </div>

        </div>
      </div>
    </div>

    <script>
      // --- 1. DATA INJECTION ---
      const items = <%- JSON.stringify(items || []) %>;
      const name = <%- JSON.stringify(name || {}) %>;
      const eanList = <%- JSON.stringify(ean || []) %>; 
      
      // Inject the active campaign data (handle if it's undefined)
      const activeCampaign = <%- JSON.stringify((typeof activeCampaign !== 'undefined') ? activeCampaign : null) %>;

      // --- 2. MODAL LOGIC ---
      function openStatsModal() {
        const modal = document.getElementById("statsModal");
        const percentEl = document.getElementById("modalPercent");
        const listEl = document.getElementById("modalErrorList");

        // Populate Data
        if (activeCampaign) {
            percentEl.innerText = (activeCampaign.percentage || 0) + "%";
            
            // Clear list
            listEl.innerHTML = "";

            if (activeCampaign.failedItems && activeCampaign.failedItems.length > 0) {
                activeCampaign.failedItems.forEach(fail => {
                    const li = document.createElement("li");
                    li.className = "error-item";
                    li.innerHTML = `
                        <span class="err-code">${fail.barcode}</span>
                        <span class="err-reason">${fail.reason}</span>
                    `;
                    listEl.appendChild(li);
                });
            } else {
                 listEl.innerHTML = '<li class="error-item" style="justify-content: center; color: #16a34a;">All items activated successfully!</li>';
            }
        }

        modal.style.display = "flex";
      }

      function closeStatsModal() {
        document.getElementById("statsModal").style.display = "none";
      }

      // Close modal if clicking outside content
      window.onclick = function(event) {
        const modal = document.getElementById("statsModal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }

      // --- 3. EXISTING SETUP & PAGINATION ---
      const rowsPerPage = 50;
      let currentPage = 1;

      var tagName = (name && name.name) ? name.name : "—";
      // Safety check for tableTitle element
      const tableTitleEl = document.getElementById("tableTitle");
      if(tableTitleEl) {
          tableTitleEl.innerText = "Available Codes: " + tagName + " (" + (items ? items.length : 0) + ")";
      }

      // Populate EAN Select
      const eanSelect = document.getElementById("eanSelect");
      if(eanSelect) {
          if(eanList && Array.isArray(eanList)) {
              eanList.forEach(e => {
                  const option = document.createElement("option");
                  option.value = e.id; 
                  option.text = e.code;
                  eanSelect.appendChild(option);
              });
          }
      }

      function renderTable() {
        const tbody = document.getElementById("tableBody");
        if(!tbody) return;
        tbody.innerHTML = "";

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = items.slice(start, end);

        if(pageData.length === 0) {
            tbody.innerHTML = "<tr><td colspan='2' style='text-align:center; padding: 20px; color: #64748b;'>No items found</td></tr>";
            return;
        }

        pageData.forEach(item => {
          const row = `
            <tr>
              <td><span class="code-pill">${item.barcode}</span></td>
              <td><span class="code-pill" style="color:#16a34a; background:#dcfce7;">${item.activation_code}</span></td>
            </tr>
          `;
          tbody.innerHTML += row;
        });

        updatePaginationControls();
      }

      function updatePaginationControls() {
        const totalPages = Math.ceil(items.length / rowsPerPage);
        const pageInfo = document.getElementById("pageInfo");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        if(pageInfo) pageInfo.innerText = `Page ${currentPage} of ${totalPages || 1}`;
        if(prevBtn) prevBtn.disabled = currentPage === 1;
        if(nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      }

      function changePage(direction) {
        const totalPages = Math.ceil(items.length / rowsPerPage);
        const newPage = currentPage + direction;
        if (newPage > 0 && newPage <= totalPages) {
          currentPage = newPage;
          renderTable();
        }
      }

      renderTable();

      // --- 4. DOWNLOAD LOGIC ---
      function downloadFile() {
        const chkBarcode = document.getElementById("chkBarcode");
        const chkActivation = document.getElementById("chkActivation");
        
        const includeBarcode = chkBarcode ? chkBarcode.checked : false;
        const includeActivation = chkActivation ? chkActivation.checked : false;

        if (!includeBarcode && !includeActivation) {
          alert("Please select at least one column to download.");
          return;
        }

        let content = "";
        items.forEach(item => {
          let line = [];
          if (includeBarcode) line.push(item.barcode);
          if (includeActivation) line.push(item.activation_code);
          content += line.join(",") + "\n";
        });

        const blob = new Blob([content], { type: "text/plain" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        
        let fileName = (name && name.name) ? name.name : "export";
        if(includeBarcode && includeActivation) a.download = `${fileName}.txt`; 
        else if(includeActivation) a.download = `${fileName}NurPin.txt`; 
        else a.download = `${fileName}NurBarcode.txt`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      // --- 5. ACTIVATION LOGIC ---
      async function runActivation() {
          const selectedEanId = document.getElementById("eanSelect").value;
          const selectedTime = document.getElementById("activateTime").value;
          const statusEl = document.getElementById("activateStatus");
          const tagId = "<%= (typeof selectedTagId !== 'undefined' ? selectedTagId : '') %>";

          if (!tagId) { alert("No tag selected."); return; }
          if (!selectedEanId) { alert("Please select an EAN code."); return; }
          if (!selectedTime) { alert("Please select a finish date and time."); return; }

          try {
            statusEl.textContent = "Scheduling activation…";
            const res = await fetch("/a26ae3e19a140048efd2/api/activation-campaign", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ tagId, eanId: selectedEanId, finishAt: selectedTime }),
            });
            const data = await res.json();

            if (!data.success) {
              statusEl.textContent = "";
              alert(data.message || "Failed to schedule activation");
              return;
            }
            statusEl.style.color = "#16a34a";
            statusEl.textContent = "✅ Activation scheduled. Reloading...";
            setTimeout(() => window.location.reload(), 700);
          } catch (err) {
            statusEl.textContent = "";
            alert("Network error.");
          }
      }

      // --- 6. PICKER LOGIC ---
      (function () {
        var userSelect = document.getElementById("userSelect");
        var tagSelect = document.getElementById("tagSelect");
        if (!userSelect || !tagSelect) return;

        userSelect.addEventListener("change", function () {
          var userId = userSelect.value;
          tagSelect.innerHTML = '<option value="" disabled selected>Choose tag...</option>';
          tagSelect.disabled = true;
          if (!userId) return;

          fetch("/a26ae3e19a140048efd2/api/user/" + encodeURIComponent(userId) + "/tags", {
            headers: { "Accept": "application/json" }
          })
          .then(r => r.json())
          .then(data => {
            if (!data || !data.success || !Array.isArray(data.tags)) return;
            data.tags.forEach(t => {
                var opt = document.createElement("option");
                opt.value = t.id; opt.text = t.name;
                tagSelect.appendChild(opt);
            });
            tagSelect.disabled = data.tags.length === 0;
          })
          .catch(() => {});
        });

        tagSelect.addEventListener("change", function () {
          var tagId = tagSelect.value;
          if (!tagId) return;
          window.location.href = "/a26ae3e19a140048efd2/download/" + encodeURIComponent(tagId);
        });
      })();
    </script>
  </body>
</html>