<%- include("partials/head", { title: "CardScan Admin Dashboard", includeChart: true }) %>
<%- include("partials/sidebar", { activePage: "dashboard" }) %>

<div class="main-wrapper">
  <%- include("partials/header", {
    notifCount: 3,
    userInitials: "AD",
    searchPlaceholder: "Search card ID or user...",
    notifications: [
      { img: "https://i.pravatar.cc/150?u=1", text: "<strong>John Doe</strong> finished the scanning", time: "2 mins ago" },
      { img: "https://i.pravatar.cc/150?u=5", text: "<strong>Sarah Lee</strong> finished the scanning", time: "15 mins ago" },
      { img: "https://i.pravatar.cc/150?u=8", text: "<strong>Mike K.</strong> requested admin access", time: "1 hour ago" }
    ]
  }) %>

  <div class="content">
    <h1 class="page-title">Overview</h1>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Total Scans</span>
          <div class="stat-icon bg-purple">
            <i class="fas fa-expand"></i>
          </div>
        </div>
        <div class="stat-value"><%= stats?.totalScans ?? 0 %></div>
        <div class="stat-diff text-up">
          <i class="fas fa-arrow-up"></i> <%= stats?.totalScansDiff ?? "0%" %> vs last month
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Activated Cards</span>
          <div class="stat-icon bg-green">
            <i class="fas fa-id-card"></i>
          </div>
        </div>
        <div class="stat-value"><%= stats?.activatedCards ?? 0 %></div>
        <div class="stat-diff text-up">
          <i class="fas fa-arrow-up"></i> <%= stats?.activatedCardsDiff ?? "0%" %> vs last month
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Activating Failed Scans</span>
          <div class="stat-icon bg-red">
            <i class="fas fa-times-circle"></i>
          </div>
        </div>
        <div class="stat-value"><%= stats?.failedScans ?? 0 %></div>
        <div class="stat-diff text-down">
          <i class="fas fa-arrow-down"></i> <%= stats?.failedScansDiff ?? "0%" %> vs last month
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Devices Online</span>
          <div class="stat-icon bg-orange"><i class="fas fa-wifi"></i></div>
        </div>
        <div class="stat-value"><%= stats?.devicesOnline ?? 0 %></div>
        <div class="stat-diff text-up">
          <i class="fas fa-check"></i> All Systems Active
        </div>
      </div>
    </div>

    <div class="analytics-grid">
      <div class="panel">
        <div class="panel-title">Scan Volume (7 Days)</div>
        <div class="chart-container">
          <canvas id="scanChart"></canvas>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Top Scanners (Today)</div>

        <ul class="user-list">
          <% (topScanners || []).forEach(u => { %>
            <li class="user-item">
              <div class="avatar"><%= (u.initials || "??") %></div>
              <div class="user-info">
                <h4><%= u.name %></h4>
                <p><%= u.location || "" %></p>
              </div>
              <span class="scan-count"><%= u.count %></span>
            </li>
          <% }) %>

          <% if (!topScanners || topScanners.length === 0) { %>
            <li class="user-item">
              <div class="user-info">
                <h4>No data</h4>
                <p>â€”</p>
              </div>
            </li>
          <% } %>
        </ul>
      </div>
    </div>
  </div>
</div>

<%- include("partials/foot", {
  extraScripts: `
    <script>
      const ctx = document.getElementById("scanChart").getContext("2d");

      let gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, "rgba(98, 98, 166, 0.3)");
      gradient.addColorStop(1, "rgba(98, 98, 166, 0.0)");

      const chartPoints = ${JSON.stringify(chartPoints || [1200,1900,1500,2200,1800,900,1100])};
      const chartLabels = ${JSON.stringify(chartLabels || ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"])};

      new Chart(ctx, {
        type: "line",
        data: {
          labels: chartLabels,
          datasets: [{
            label: "Cards Scanned",
            data: chartPoints,
            backgroundColor: gradient,
            borderColor: "#6262A6",
            borderWidth: 2,
            pointBackgroundColor: "#ffffff",
            pointBorderColor: "#6262A6",
            pointRadius: 5,
            pointHoverRadius: 7,
            fill: true,
            tension: 0.4,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        },
      });
    </script>
  `
}) %>