<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Monthly Summary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      * {
        box-sizing: border-box;
        font-family: Inter, sans-serif;
      }
      body {
        margin: 0;
        background: #f1f5f9;
        color: #1e293b;
        display: flex;
        min-height: 100vh;
      }

      :root {
        --sidebar-width: 260px;
      }

      /* LAYOUT UTILS */
      .main-wrapper {
        margin-left: var(--sidebar-width);
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
      }

      header {
        background: #fff;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .content {
        padding: 32px;
        max-width: 1600px;
        width: 100%;
        margin: 0 auto;
      }

      .page-title {
        font-size: 26px;
        font-weight: 700;
        margin-bottom: 6px;
      }
      .subtitle {
        font-size: 13px;
        color: #64748b;
        margin-bottom: 24px;
      }

      /* CONTROLS */
      .controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-bottom: 24px;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .label {
        font-size: 11px;
        font-weight: 700;
        color: #64748b;
        margin-bottom: 6px;
        text-transform: uppercase;
      }
      .input {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        min-width: 220px;
        background: #fff;
      }
      .btn {
        background: #6262a6;
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }
      .btn:hover {
        background: #4e4e85;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid #cbd5e1;
        color: #475569;
      }
      .btn-outline:hover {
        background: #f1f5f9;
        border-color: #94a3b8;
      }

      /* COMMON UI ELEMENTS */
      .panel {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      thead th {
        text-align: left;
        padding: 12px;
        background: #f8fafc;
        color: #64748b;
        border-bottom: 1px solid #e2e8f0;
        font-size: 12px;
        text-transform: uppercase;
        white-space: nowrap;
      }
      tbody td {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      tbody tr:hover {
        background: #f8fafc;
      }

      .pill {
        background: #f1f5f9;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 13px;
        display: inline-block;
        min-width: 44px;
        text-align: center;
      }
      .link {
        color: #6262a6;
        text-decoration: none;
        font-weight: 600;
      }
      .link:hover {
        text-decoration: underline;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 10px;
        gap: 16px;
        border-bottom: 1px dashed #e2e8f0;
        padding-bottom: 8px;
      }
      .summary-row:last-child {
        border-bottom: none;
      }
      .summary-actions {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      /* --- SINGLE USER VIEW (Split Grid) --- */
      .single-view-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        align-items: start;
      }

      /* --- ALL USERS VIEW (Card List) --- */
      #all-view-container {
        display: flex;
        flex-direction: column;
        gap: 32px;
      }

      /* The "Global" sticky header for All Users mode */
      .global-stats-bar {
        background: #1e293b;
        color: #fff;
        padding: 16px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 10px;
      }
      .global-stat-group {
        display: flex;
        gap: 24px;
      }
      .g-stat {
        display: flex;
        flex-direction: column;
      }
      .g-stat span {
        font-size: 11px;
        opacity: 0.7;
        text-transform: uppercase;
        font-weight: 700;
      }
      .g-stat strong {
        font-size: 18px;
      }

      /* The per-user Card */
      .user-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        border: 1px solid #e2e8f0;
      }

      .user-card-header {
        background: #f8fafc;
        padding: 16px 24px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .uc-title {
        font-size: 18px;
        font-weight: 800;
        color: #334155;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .uc-badge {
        background: #6262a6;
        color: white;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 99px;
      }

      /* Grid inside the user card: Table Left, Summary Right */
      .user-card-body {
        padding: 24px;
        display: grid;
        grid-template-columns: 3fr 1fr; /* Table gets more space */
        gap: 32px;
        align-items: start;
      }

      /* Adjust summary inside card to look cleaner */
      .mini-summary-box {
        background: #f8fafc;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e2e8f0;
      }
      .mini-summary-title {
        font-weight: 700;
        margin-bottom: 12px;
        color: #475569;
        font-size: 14px;
        text-transform: uppercase;
      }

      @media (max-width: 1100px) {
        .single-view-grid {
          grid-template-columns: 1fr;
        }
        .user-card-body {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <%- include("partials/sidebar", { activePage: "monthlyPayload" }) %>

    <div class="main-wrapper">
      <header>
        <strong>Monthly Report</strong>
        <div
          style="
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #6262a6;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
          "
        >
          AD
        </div>
      </header>

      <div class="content">
        <div class="page-title">Monthly Report</div>
        <div class="subtitle">Select user and month to view tag usage.</div>

        <div class="controls">
          <div>
            <div class="label">User</div>
            <select id="userSelect" class="input">
              <option value="" disabled selected>Select userâ€¦</option>
              <option value="all">All users (Combined Report)</option>
              <% users.forEach(u => { %>
              <option value="<%= u.id %>"><%= u.name %></option>
              <% }) %>
            </select>
          </div>
          <div>
            <div class="label">Month</div>
            <input type="month" id="monthSelect" class="input" />
          </div>
          <button class="btn" id="loadBtn">
            <i class="fas fa-rotate"></i> Load Data
          </button>
        </div>

        <div
          id="single-view-container"
          class="single-view-grid"
          style="display: none"
        >
          <div class="panel">
            <h3
              style="
                margin-top: 0;
                border-bottom: 1px solid #e2e8f0;
                padding-bottom: 12px;
                margin-bottom: 0;
              "
            >
              Tags
            </h3>
            <table>
              <thead>
                <tr>
                  <th width="40">Use</th>
                  <th>Tag Name</th>
                  <th>Date</th>
                  <th>Cards</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tbodySingle"></tbody>
            </table>
          </div>

          <div class="panel">
            <h3 style="margin-top: 0">Summary</h3>
            <div class="summary-row">
              <span>Total rows</span><strong id="rowCount">0</strong>
            </div>
            <div class="summary-row">
              <span>All cards</span><strong id="allTotal">0</strong>
            </div>
            <div class="summary-row">
              <span>Included cards</span><strong id="includedTotal">0</strong>
            </div>
            <div class="summary-actions">
              <button class="btn btn-outline" id="checkAllSingle">
                <i class="fa-regular fa-square-check"></i> Check all
              </button>
              <button class="btn btn-outline" id="uncheckAllSingle">
                <i class="fa-regular fa-square"></i> Uncheck all
              </button>
            </div>
          </div>
        </div>

        <div id="all-view-container" style="display: none">
          <div class="global-stats-bar">
            <div class="global-stat-group">
              <div class="g-stat">
                <span>Users</span><strong id="g-users">0</strong>
              </div>
              <div class="g-stat">
                <span>Total Cards</span><strong id="g-cards">0</strong>
              </div>
            </div>
            <div style="display: flex; gap: 10px">
              <button
                class="btn"
                style="background: rgba(255, 255, 255, 0.2)"
                id="checkAllGlobal"
              >
                Check All Global
              </button>
              <button
                class="btn"
                style="background: rgba(255, 255, 255, 0.2)"
                id="uncheckAllGlobal"
              >
                Uncheck All Global
              </button>
            </div>
          </div>

          <div id="allUsersList"></div>
        </div>
      </div>
    </div>

    <script>
      // --- STATE & INIT ---
      const monthInput = document.getElementById("monthSelect");
      const now = new Date();
      monthInput.value =
        now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0");
      const userSelect = document.getElementById("userSelect");

      // Single View Elements
      const singleContainer = document.getElementById("single-view-container");
      const tbodySingle = document.getElementById("tbodySingle");
      const rowCount = document.getElementById("rowCount");
      const allTotal = document.getElementById("allTotal");
      const includedTotal = document.getElementById("includedTotal");

      // All View Elements
      const allContainer = document.getElementById("all-view-container");
      const allUsersList = document.getElementById("allUsersList");
      const gUsers = document.getElementById("g-users");
      const gCards = document.getElementById("g-cards");

      let state = { items: [], included: {} };

      // --- HELPERS ---
      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      function keyOf(t) {
        return t._rowId || t.id;
      }

      // Group items by user_id
      function groupByUser(items) {
        const map = new Map();
        for (const t of items) {
          const uid = t.user_id || "unknown";
          if (!map.has(uid)) {
            map.set(uid, {
              user_name: t.user_name || t.user_id || "Unknown User",
              user_id: uid,
              rows: [],
            });
          }
          map.get(uid).rows.push(t);
        }
        return Array.from(map.values()).sort((a, b) =>
          a.user_name.localeCompare(b.user_name)
        );
      }

      function computeTotals(rows) {
        let all = 0,
          inc = 0;
        for (const t of rows) {
          const c = Number(t.count) || 0;
          all += c;
          if (state.included[keyOf(t)]) inc += c;
        }
        // Money logic removed
        return { all, inc, rows: rows.length };
      }

      // --- RENDER LOGIC ---

      function render() {
        const isAll = userSelect.value === "all";

        // Toggle View Containers
        singleContainer.style.display = isAll
          ? "none"
          : state.items.length > 0
          ? "grid"
          : "none";
        allContainer.style.display = isAll ? "flex" : "none";

        if (state.items.length === 0) return; // Wait for load or empty

        if (isAll) {
          renderAllView();
        } else {
          renderSingleView();
        }
      }

      // 1. Single User Render
      function renderSingleView() {
        // Table
        let html = "";
        state.items.sort((a, b) => new Date(b.date) - new Date(a.date));

        for (const t of state.items) {
          const key = keyOf(t);
          const isChecked = state.included[key] ? "checked" : "";
          const openHref = `/a26ae3e19a140048efd2/download/${encodeURIComponent(
            t.id
          )}`;

          html += `
        <tr>
          <td><input type="checkbox" data-key="${key}" ${isChecked} style="cursor:pointer; width:16px; height:16px;"></td>
          <td>${escapeHtml(t.name)}</td>
          <td>${new Date(t.date).toLocaleDateString()}</td>
          <td><span class="pill">${escapeHtml(t.count)}</span></td>
          <td><a class="link" href="${openHref}">Open</a></td>
        </tr>`;
        }
        tbodySingle.innerHTML = html;

        // Summary
        const t = computeTotals(state.items);
        rowCount.textContent = t.rows;
        allTotal.textContent = t.all;
        includedTotal.textContent = t.inc;
      }

      // 2. All Users Render (The new layout)
      function renderAllView() {
        const users = groupByUser(state.items);

        // Global Stats Calculation
        let globalInc = 0;

        let html = "";

        users.forEach((u) => {
          // Sort rows
          u.rows.sort((a, b) => new Date(b.date) - new Date(a.date));

          // Compute specific user stats
          const stats = computeTotals(u.rows);
          globalInc += stats.inc;

          // --- USER CARD HTML ---
          html += `
      <div class="user-card" style="margin-top:15px">
        <div class="user-card-header">
          <div class="uc-title">
            ${escapeHtml(u.user_name)} 
            <span class="uc-badge">${u.rows.length} tags</span>
          </div>
          <div>User ID: ${escapeHtml(u.user_id)}</div>
        </div>

        <div class="user-card-body">
          
          <div class="user-table-wrap">
            <table>
              <thead>
                <tr>
                  <th width="40">Use</th>
                  <th>Tag Name</th>
                  <th>Date</th>
                  <th>Cards</th>
                  <th>Open</th>
                </tr>
              </thead>
              <tbody>
      `;

          // Table Rows
          u.rows.forEach((row) => {
            const key = keyOf(row);
            const isChecked = state.included[key] ? "checked" : "";
            const openHref = `/a26ae3e19a140048efd2/download/${encodeURIComponent(
              row.id
            )}?userId=${encodeURIComponent(u.user_id)}`;

            html += `
            <tr>
              <td><input type="checkbox" data-key="${key}" ${isChecked} style="cursor:pointer;"></td>
              <td>${escapeHtml(row.name)}</td>
              <td>${new Date(row.date).toLocaleDateString()}</td>
              <td><span class="pill">${escapeHtml(row.count)}</span></td>
              <td><a class="link" href="${openHref}">Open</a></td>
            </tr>
        `;
          });

          html += `
              </tbody>
            </table>
          </div>

          <div class="mini-summary-box">
            <div class="mini-summary-title">Summary for ${escapeHtml(
              u.user_name.split(" ")[0]
            )}</div>
            
            <div class="summary-row"><span>Total Cards</span><strong>${
              stats.all
            }</strong></div>
            <div class="summary-row"><span>Included</span><strong>${
              stats.inc
            }</strong></div>
            <div class="summary-actions">
               <button class="btn btn-outline" style="font-size:12px; padding:6px 10px;" data-user-action="check" data-uid="${
                 u.user_id
               }">Check All</button>
               <button class="btn btn-outline" style="font-size:12px; padding:6px 10px;" data-user-action="uncheck" data-uid="${
                 u.user_id
               }">Uncheck All</button>
            </div>
          </div>

        </div> </div> `;
        });

        allUsersList.innerHTML =
          html ||
          `<div style="text-align:center; padding:40px; color:#94a3b8;">No data found.</div>`;

        // Update Global Top Bar
        gUsers.textContent = users.length;
        gCards.textContent = globalInc;
      }

      // --- EVENT HANDLERS ---

      // 1. Load Data
      document.getElementById("loadBtn").onclick = async () => {
        const userId = userSelect.value;
        const month = monthInput.value;
        if (!userId || !month) return alert("Select user and month");

        // Reset UI
        state.items = [];
        render();

        // Show Loading
        const isAll = userId === "all";
        if (isAll)
          allUsersList.innerHTML = `<div style="text-align:center;padding:40px;">Loading data...</div>`;
        else
          tbodySingle.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;">Loading...</td></tr>`;

        try {
          const res = await fetch(
            `/a26ae3e19a140048efd2/api/monthly-payout?userId=${encodeURIComponent(
              userId
            )}&month=${encodeURIComponent(month)}`
          );
          const data = await res.json();
          state.items = data.items || [];

          // Default Check All
          state.included = {};
          state.items.forEach((t) => (state.included[keyOf(t)] = true));

          render();
        } catch (e) {
          alert("Error loading data");
          console.error(e);
        }
      };

      // 2. Checkbox Toggles (Delegation)
      document.addEventListener("change", (e) => {
        if (e.target.type === "checkbox" && e.target.dataset.key) {
          state.included[e.target.dataset.key] = e.target.checked;
          render();
        }
      });

      // 3. User Specific Check/Uncheck (In All View)
      document.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const action = btn.dataset.userAction;
        const uid = btn.dataset.uid;

        if (action && uid) {
          const shouldCheck = action === "check";
          state.items.forEach((t) => {
            if (String(t.user_id) === String(uid)) {
              state.included[keyOf(t)] = shouldCheck;
            }
          });
          render();
        }
      });

      // 4. Single View Buttons
      document.getElementById("checkAllSingle").onclick = () => {
        state.items.forEach((t) => (state.included[keyOf(t)] = true));
        render();
      };
      document.getElementById("uncheckAllSingle").onclick = () => {
        state.items.forEach((t) => (state.included[keyOf(t)] = false));
        render();
      };

      // 5. Global Buttons (All View)
      document.getElementById("checkAllGlobal").onclick = () => {
        state.items.forEach((t) => (state.included[keyOf(t)] = true));
        render();
      };
      document.getElementById("uncheckAllGlobal").onclick = () => {
        state.items.forEach((t) => (state.included[keyOf(t)] = false));
        render();
      };
    </script>
  </body>
</html>
