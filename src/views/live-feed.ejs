<%- include("partials/head", { title: "Live Feed | CardScan Admin", includeChart: false }) %>

<%- include("partials/sidebar", { activePage: "live-feed" }) %>

<div class="main-wrapper">
  <%- include("partials/header", {
    searchPlaceholder: "Search barcode / activation / user / tag...",
    showLivePill: true,          // we will handle in header partial
    livePillTitle: "Updates every 3 seconds",
    notifCount: 0,
    userInitials: "AD",
    notifications: []
  }) %>

  <div class="content">
    <div class="page-head">
      <div>
        <div class="page-title">Live Feed</div>
        <div class="subtle">Newest scans appear on top automatically.</div>
      </div>

      <div class="pill">
        <i class="fas fa-list"></i>
        Showing <span id="rowCount"><%= (items || []).length %></span>
      </div>
    </div>

    <div class="table-card">
      <div style="overflow-x:auto;">
        <table class="min-w-full">
          <thead>
            <tr>
              <th>Barcode</th>
              <th>User</th>
              <th>Tag</th>
              <th>Activation</th>
              <th>Created</th>
              <th>Image</th>
            </tr>
          </thead>

          <tbody id="feedBody">
            <% (items || []).forEach(it => { %>
              <tr data-id="<%= it.id %>" data-search="<%= [
                it.barcode,
                it.activation_code || '',
                it.app_user?.name || '',
                it.tag?.name || ''
              ].join(' ').toLowerCase() %>">

                <td class="mono" style="font-weight:700; color:#0f172a;"><%= it.barcode %></td>

                <td>
                  <div class="user-chip">
                    <div class="avatar"><%= it.app_user ? it.app_user.name.charAt(0).toUpperCase() : '?' %></div>
                    <span><%= it.app_user ? it.app_user.name : 'N/A' %></span>
                  </div>
                </td>

                <td>
                  <% if (it.tag) { %>
                    <span class="tag-pill"><%= it.tag.name %></span>
                  <% } else { %>
                    <span style="color:#94a3b8;">N/A</span>
                  <% } %>
                </td>

                <td class="mono" style="color:#475569;"><%= it.activation_code || "-" %></td>

                <td style="color:#64748b;">
                  <%= new Date(it.created_at).toLocaleDateString() %>
                  <span style="font-size:12px; color:#94a3b8;"><%= new Date(it.created_at).toLocaleTimeString() %></span>
                </td>

                <td>
                  <% if (it.img_src) { %>
                    <a class="view-link" href="/admin/item/<%= it.id %>">View</a>
                  <% } else { %>
                    <span style="color:#cbd5e1;">-</span>
                  <% } %>
                </td>

              </tr>
            <% }) %>

            <% if (!items || items.length === 0) { %>
              <tr>
                <td colspan="6" style="padding: 26px; color: #94a3b8;">
                  No items yet.
                </td>
              </tr>
            <% } %>
          </tbody>

        </table>
      </div>
    </div>
  </div>
</div>

<%- include("partials/foot", {
  extraScripts: `
    <script>
      // last seen timestamp (kept for later if you re-enable polling)
      let lastTs = "${(latestTs || "")}";

      const feedBody = document.getElementById("feedBody");
      const rowCount = document.getElementById("rowCount");
      const searchInput = document.getElementById("searchInput");

      function applySearchFilter() {
        const q = (searchInput?.value || "").trim().toLowerCase();
        const rows = feedBody.querySelectorAll("tr");
        rows.forEach(r => {
          const hay = r.getAttribute("data-search") || "";
          r.style.display = !q || hay.includes(q) ? "" : "none";
        });
      }

      if (searchInput) {
        searchInput.addEventListener("input", applySearchFilter);
      }
    </script>
  `
}) %>