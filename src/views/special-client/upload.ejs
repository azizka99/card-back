<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Client Upload</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 24px;
        display: flex;
        justify-content: center;
      }
      .container {
        width: 100%;
        max-width: 900px;
        background: #ffffff;
        border-radius: 16px;
        padding: 24px 24px 32px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      h1 {
        margin-top: 0;
        font-size: 22px;
        margin-bottom: 8px;
      }
      p {
        margin-top: 0;
        color: #4b5563;
        font-size: 14px;
      }
      .section {
        margin-top: 24px;
      }
      .section-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }
      .tag-search {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .tag-search-row {
        display: flex;
        gap: 8px;
      }
      .tag-search input[type="text"] {
        flex: 1;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 14px;
      }
      .tag-search select {
        width: 100%;
        height: 180px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        padding: 6px;
        font-size: 14px;
      }
      .tag-hint {
        font-size: 12px;
        color: #6b7280;
      }
      .upload-box {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        background: #f9fafb;
      }
      .upload-box p {
        margin: 4px 0;
        font-size: 13px;
      }
      .upload-box input[type="file"] {
        margin-top: 8px;
      }
      .info {
        font-size: 12px;
        color: #6b7280;
        margin-top: 6px;
      }
      .actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 24px;
        gap: 12px;
        flex-wrap: wrap;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border-radius: 999px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-primary {
        background: #111827;
        color: #ffffff;
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }
      #status {
        font-size: 13px;
        color: #374151;
      }
      #status.error {
        color: #b91c1c;
      }
      #status.success {
        color: #047857;
      }
      #fileSummary {
        font-size: 13px;
        color: #374151;
        margin-top: 8px;
      }
      progress {
        width: 100%;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Special Client Upload</h1>
      <p>
        Wähle zuerst den richtigen <strong>Tag</strong>, danach den Ordner mit
        allen Bildern. Die Dateinamen müssen im Format
        <code>BARCODE_AKTIVATIONSCODE.jpg</code> sein.
      </p>

      <!-- TAG SELECTION -->
      <div class="section">
        <div class="section-title">1. Tag auswählen</div>
        <div class="tag-search">
          <div class="tag-search-row">
            <input
              type="text"
              id="tagSearch"
              placeholder="Tag suchen (Name eingeben)..."
            />
          </div>

          <select id="tagSelect" size="8">
            <% if (tags && tags.length) { %> <% tags.forEach(function(tag) { %>
            <option value="<%= tag.id %>"><%= tag.name %></option>
            <% }) %> <% } %>
          </select>

          <div class="tag-hint">
            Tipp: Oben nach Namen filtern, dann Tag anklicken. Der ausgewählte
            Tag wird für alle hochgeladenen Bilder verwendet.
          </div>
        </div>
      </div>

      <!-- FILE/FOLDER UPLOAD -->
      <div class="section">
        <div class="section-title">2. Ordner mit Bildern auswählen</div>
        <div class="upload-box">
          <p><strong>Ordner wählen</strong> mit allen Kartenbildern.</p>
          <p>(4.000–7.000 Dateien sind in Ordnung.)</p>
          <input
            type="file"
            id="fileInput"
            name="files"
            multiple
            webkitdirectory
          />
          <div class="info">
            Hinweis: Die Bilder werden in kleineren Blöcken hochgeladen, um
            Verbindungsprobleme zu vermeiden.
          </div>
          <div id="fileSummary"></div>
        </div>
      </div>

      <!-- ACTIONS & STATUS -->
      <div class="section">
        <div class="actions">
          <div style="flex: 2 1 200px">
            <button id="uploadBtn" class="btn btn-primary" type="button">
              Upload starten
            </button>
            <button
              class="btn btn-secondary"
              type="button"
              onclick="document.getElementById('logoutForm').submit()"
            >
              Logout
            </button>
          </div>
          <div style="flex: 3 1 250px">
            <div id="status"></div>
            <progress
              id="progress"
              value="0"
              max="100"
              style="display: none"
            ></progress>
          </div>
        </div>
      </div>

      <form
        id="logoutForm"
        method="post"
        action="/special-client/logout"
        style="display: none"
      ></form>
    </div>

    <script>
      const tagSearchInput = document.getElementById("tagSearch");
      const tagSelect = document.getElementById("tagSelect");
      const fileInput = document.getElementById("fileInput");
      const fileSummary = document.getElementById("fileSummary");
      const uploadBtn = document.getElementById("uploadBtn");
      const statusEl = document.getElementById("status");
      const progressEl = document.getElementById("progress");

      // Keep all selected files so we can retry failed ones
      let allFiles = [];
      // Map: filename → { ok: boolean, error?: string }
      const uploadResults = new Map();

      // Helper to identify a file (backend uses originalname)
      function fileKey(file) {
        return file.name; // works with your current backend (name = originalname)
      }

      // --- TAG SEARCH ---
      if (tagSearchInput && tagSelect) {
        tagSearchInput.addEventListener("input", () => {
          const q = tagSearchInput.value.toLowerCase();
          for (const opt of tagSelect.options) {
            const text = opt.textContent.toLowerCase();
            opt.style.display = text.includes(q) ? "" : "none";
          }
        });
      }

      // --- FILE SUMMARY ---
      if (fileInput) {
        fileInput.addEventListener("change", () => {
          allFiles = Array.from(fileInput.files || []);
          uploadResults.clear();

          if (!allFiles.length) {
            fileSummary.textContent = "Keine Dateien ausgewählt.";
          } else {
            fileSummary.textContent =
              allFiles.length + " Datei(en) ausgewählt.";
          }
        });
      }

      function setStatus(msg, type) {
        statusEl.textContent = msg;
        statusEl.className = "";
        if (type) {
          statusEl.classList.add(type);
        }
      }

      // Show final summary + list of failed filenames
      function summarizeResults() {
        let successCount = 0;
        let failCount = 0;
        const failedNames = [];

        for (const [name, res] of uploadResults.entries()) {
          if (res.ok) successCount++;
          else {
            failCount++;
            failedNames.push(name + (res.error ? " (" + res.error + ")" : ""));
          }
        }

        if (successCount === 0 && failCount === 0) {
          setStatus("Keine Upload-Ergebnisse vorhanden.", "");
          return;
        }

        let msg =
          "Fertig. Erfolgreich: " +
          successCount +
          ", Fehlgeschlagen: " +
          failCount +
          ".";

        if (failCount > 0) {
          msg +=
            " Fehlgeschlagene Dateien sind unten aufgelistet. Du kannst sie erneut hochladen.";
        }

        setStatus(msg, failCount > 0 ? "error" : "success");

        // Create / update failed list element
        const failedListId = "failedList";
        let failedListEl = document.getElementById(failedListId);
        if (failedListEl) failedListEl.remove();

        if (failCount > 0) {
          failedListEl = document.createElement("pre");
          failedListEl.id = failedListId;
          failedListEl.style.marginTop = "8px";
          failedListEl.style.fontSize = "12px";
          failedListEl.style.maxHeight = "200px";
          failedListEl.style.overflow = "auto";
          failedListEl.textContent =
            "Fehlgeschlagen:\n" + failedNames.join("\n");
          statusEl.parentElement.appendChild(failedListEl);
        }
      }

      // --- Upload one chunk and store per-file results ---
      async function uploadChunk(files, tagId, alreadyUploaded, total) {
        const formData = new FormData();
        formData.append("tagId", tagId);
        for (const file of files) {
          formData.append("files", file);
        }

        const res = await fetch("/special-client/upload-files", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(
            "Fehler beim Upload (Status " + res.status + "): " + text
          );
        }

        const data = await res.json();
        const results = data.results || [];

        // Store per-file results
        for (const r of results) {
          uploadResults.set(r.name, { ok: !!r.ok, error: r.error });
        }

        const uploaded = alreadyUploaded + files.length;
        const percent = Math.round((uploaded / total) * 100);
        progressEl.value = percent;
        setStatus(
          "Hochgeladen: " +
            uploaded +
            " / " +
            total +
            " Dateien (" +
            percent +
            "%)...",
          ""
        );

        return uploaded;
      }

      // --- Core upload for a given list of files ---
      async function uploadFiles(filesToUpload) {
        const selectedOption = tagSelect.options[tagSelect.selectedIndex];
        if (!selectedOption) {
          setStatus("Bitte zuerst einen Tag auswählen.", "error");
          return;
        }
        const tagId = selectedOption.value;

        const total = filesToUpload.length;
        if (!total) {
          setStatus("Keine Dateien zum Hochladen.", "error");
          return;
        }

        const chunkSize = 20; // 20 files per request
        let uploaded = 0;

        setStatus("Upload gestartet...", "");
        progressEl.style.display = "block";
        progressEl.value = 0;

        for (let i = 0; i < total; i += chunkSize) {
          const chunk = filesToUpload.slice(i, i + chunkSize);
          uploaded = await uploadChunk(chunk, tagId, uploaded, total);
        }
      }

      // --- Main button: full upload + auto retry for failed files ---
      uploadBtn.addEventListener("click", async () => {
        if (!allFiles.length) {
          setStatus("Bitte zuerst einen Ordner / Dateien auswählen.", "error");
          return;
        }

        uploadBtn.disabled = true;

        try {
          // 1) First attempt: all files
          uploadResults.clear();
          await uploadFiles(allFiles);

          // 2) Find failed ones
          const failedFilesFirstRun = allFiles.filter((file) => {
            const key = fileKey(file);
            const res = uploadResults.get(key);
            return !res || !res.ok;
          });

          // 3) If there are failures, automatically retry them once
          if (failedFilesFirstRun.length > 0) {
            setStatus(
              "Es gab Fehler. Versuche, fehlgeschlagene Dateien erneut hochzuladen...",
              "error"
            );
            await uploadFiles(failedFilesFirstRun);
          }

          // 4) Final summary
          summarizeResults();
        } catch (err) {
          console.error(err);
          setStatus("Fehler: " + err.message, "error");
        } finally {
          uploadBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
